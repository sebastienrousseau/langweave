name: ğŸŒ™ Nightly Maintenance

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual triggering

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  # =============================================================================
  # DEPENDENCY UPDATE CHECKS
  # =============================================================================
  dependency-updates:
    name: ğŸ”„ Dependency Update Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¦€ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ“¦ Install cargo-edit and cargo-outdated
        run: |
          cargo install cargo-edit cargo-outdated --locked

      - name: ğŸ” Check for outdated dependencies
        run: |
          echo "ğŸ” Checking for outdated dependencies..."
          cargo outdated --format json > outdated.json

          # Check if we have any outdated dependencies
          OUTDATED_COUNT=$(cat outdated.json | grep -o '"name"' | wc -l)

          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "ğŸ“¦ Found $OUTDATED_COUNT outdated dependencies:"
            cargo outdated

            # Create issue or comment about outdated dependencies
            echo "âš ï¸ Outdated dependencies detected in nightly check"

            # Store results for the security scan
            echo "DEPENDENCIES_OUTDATED=true" >> $GITHUB_ENV
          else
            echo "âœ… All dependencies are up to date"
            echo "DEPENDENCIES_OUTDATED=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”’ Security audit on latest dependencies
        run: |
          echo "ğŸ”’ Running security audit..."
          cargo install cargo-audit --locked

          # Update to latest versions for security check
          cargo update

          # Run security audit - this should never be bypassed
          cargo-audit audit

          echo "âœ… Security audit passed with latest dependencies"

      - name: ğŸ¦€ Verify MSRV compatibility
        run: |
          echo "ğŸ¦€ Verifying declared MSRV in nightly maintenance..."
          cargo install cargo-msrv --locked
          cargo msrv verify -- cargo check --workspace --all-targets --all-features --locked
          echo "âœ… Nightly MSRV verification passed"

      - name: ğŸ“‹ Generate dependency report
        run: |
          echo "ğŸ“‹ Generating dependency analysis report..."

          # Generate comprehensive dependency information
          echo "# Nightly Dependency Report - $(date)" > dependency_report.md
          echo "" >> dependency_report.md

          echo "## Current Dependencies" >> dependency_report.md
          cargo tree --format "{p} {l}" >> dependency_report.md
          echo "" >> dependency_report.md

          if [ "$DEPENDENCIES_OUTDATED" = "true" ]; then
            echo "## Outdated Dependencies" >> dependency_report.md
            cargo outdated >> dependency_report.md
            echo "" >> dependency_report.md
          fi

          echo "## Security Audit Results" >> dependency_report.md
          cargo-audit audit --format json > audit_results.json
          echo "No vulnerabilities found as of $(date)" >> dependency_report.md

          cat dependency_report.md

  # =============================================================================
  # BETA/NIGHTLY COMPILER TESTING
  # =============================================================================
  nightly-compiler:
    name: ğŸš€ Nightly Compiler Test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    continue-on-error: true  # Don't fail the workflow if nightly breaks
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        toolchain: [beta, nightly]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust toolchain (${{ matrix.toolchain }})
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.toolchain }}
          components: rustfmt, clippy

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.toolchain }}-nightly-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ”¨ Test build with ${{ matrix.toolchain }}
        run: |
          echo "ğŸ”¨ Testing build with ${{ matrix.toolchain }} toolchain..."

          # Temporarily remove warnings-as-errors for nightly testing
          export RUSTFLAGS=""

          # Test basic build
          cargo build --all-targets --all-features --workspace

          echo "âœ… Build successful with ${{ matrix.toolchain }}"

      - name: ğŸ§ª Run tests with ${{ matrix.toolchain }}
        run: |
          echo "ğŸ§ª Running tests with ${{ matrix.toolchain }} toolchain..."

          # Run tests without warnings-as-errors
          export RUSTFLAGS=""

          cargo test --all-features --workspace

          echo "âœ… Tests passed with ${{ matrix.toolchain }}"

      - name: ğŸ“‹ Check lints with ${{ matrix.toolchain }}
        run: |
          echo "ğŸ“‹ Checking lints with ${{ matrix.toolchain }}..."

          # Run clippy but don't fail on warnings for nightly
          cargo clippy --all-targets --all-features --workspace || echo "âš ï¸ Clippy warnings with ${{ matrix.toolchain }}"

          echo "âœ… Lint check completed with ${{ matrix.toolchain }}"

  # =============================================================================
  # EXTENDED TEST RUNS
  # =============================================================================
  extended-tests:
    name: ğŸ§ª Extended Test Suite
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¦€ Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-extended-${{ hashFiles('**/Cargo.lock') }}

      - name: ğŸ§ª Run property-based tests
        run: |
          echo "ğŸ§ª Running extended property-based tests..."
          cargo test --all-features --workspace --release -- --ignored
          echo "âœ… Property-based tests completed"

      - name: ğŸƒâ€â™‚ï¸ Run performance benchmarks
        run: |
          echo "ğŸƒâ€â™‚ï¸ Running performance benchmarks..."
          cargo bench --all-features
          echo "âœ… Benchmarks completed"

      - name: ğŸ”„ Run stress tests
        run: |
          echo "ğŸ”„ Running stress tests..."
          # Run tests multiple times to catch race conditions and flaky tests
          for i in {1..5}; do
            echo "ğŸ”„ Stress test iteration $i/5"
            cargo test --all-features --workspace --release
          done
          echo "âœ… Stress tests completed"

      - name: ğŸ’¾ Memory leak detection
        run: |
          echo "ğŸ’¾ Running memory leak detection..."

          # Install valgrind on Linux for memory leak detection
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y valgrind

            # Run a simple test under valgrind
            cargo test --all-features --workspace --bin langweave || echo "âš ï¸ Memory leak check completed"
          else
            echo "âš ï¸ Memory leak detection skipped on $RUNNER_OS"
          fi

  # =============================================================================
  # MAINTENANCE REPORT
  # =============================================================================
  maintenance-report:
    name: ğŸ“Š Generate Maintenance Report
    runs-on: ubuntu-latest
    needs: [dependency-updates, nightly-compiler, extended-tests]
    if: always()  # Run even if other jobs fail

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Generate nightly maintenance report
        run: |
          echo "ğŸ“Š Generating nightly maintenance report..."

          # Create comprehensive maintenance report
          echo "# Nightly Maintenance Report - $(date)" > maintenance_report.md
          echo "" >> maintenance_report.md

          echo "## Job Status Summary" >> maintenance_report.md
          echo "- Dependency Updates: ${{ needs.dependency-updates.result }}" >> maintenance_report.md
          echo "- Nightly Compiler: ${{ needs.nightly-compiler.result }}" >> maintenance_report.md
          echo "- Extended Tests: ${{ needs.extended-tests.result }}" >> maintenance_report.md
          echo "" >> maintenance_report.md

          echo "## Next Actions Required" >> maintenance_report.md
          if [ "${{ needs.dependency-updates.result }}" != "success" ]; then
            echo "- âš ï¸ Review dependency update issues" >> maintenance_report.md
          fi

          if [ "${{ needs.nightly-compiler.result }}" != "success" ]; then
            echo "- âš ï¸ Investigate nightly compiler compatibility" >> maintenance_report.md
          fi

          if [ "${{ needs.extended-tests.result }}" != "success" ]; then
            echo "- âš ï¸ Address extended test failures" >> maintenance_report.md
          fi

          echo "" >> maintenance_report.md
          echo "## Health Status" >> maintenance_report.md
          if [ "${{ needs.dependency-updates.result }}" = "success" ] && [ "${{ needs.extended-tests.result }}" = "success" ]; then
            echo "ğŸŸ¢ Project health: GOOD" >> maintenance_report.md
          else
            echo "ğŸŸ¡ Project health: NEEDS ATTENTION" >> maintenance_report.md
          fi

          cat maintenance_report.md

      - name: ğŸ“¤ Archive maintenance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-maintenance-report-${{ github.run_number }}
          path: |
            maintenance_report.md
            dependency_report.md
            outdated.json
            audit_results.json
          retention-days: 30
